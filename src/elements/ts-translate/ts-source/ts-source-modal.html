
<link rel="import" href="../../../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../components/paper-button/paper-button.html">
<link rel="import" href="../../../components/paper-checkbox/paper-checkbox.html">

<dom-module id="ts-source-modal">

    <style>

        :host {
            box-sizing: border-box;
            display: flex;
            flex: auto;
        }

        #contain {
            flex: auto;
            display: flex;
            flex-direction: column;
            color: var(--primary-text-color);
            overflow: hidden;
            background: var(--card-background-color);
            font-size: 110%;
        }

        [icon="search"] {
            padding: 0;
        }

        .header {
            flex: 0 0 50px;
            color: var(--secondary-text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        input {
            border: none;
            font-size: 110%;
            font-style: italic;
            width: 100%;
        }

        input:focus {
            outline: none;
        }

        .body {
            flex: auto;
            overflow-y: auto;
        }

        .row {
            display: flex;
            margin: 0;
            padding: 1em;
            border-bottom: 1px solid var(--border-color);
        }

        .left {
            justify-content: space-between;
        }

        .right {
            justify-content: flex-end;
        }

        .buttons {
            display: flex;
            justify-content: flex-end;
        }

        .row-header {
            margin: 0;
            padding: 0.25em 1em;
            background-color: var(--border-color);
            text-transform: uppercase;
            font-size: 80%;
            font-weight: 500;
            color: var(--secondary-text-color);
        }

        .footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex: 0 0 50px;
            border-top: 1px solid var(--border-color);
        }

        .footer paper-button {
            color: var(--secondary-text-color);
        }

        .footer paper-button:hover {
            color: var(--accent-color);
        }

        .body paper-button {
            background: var(--accent-color);
            color: var(--reverse-text-color);
            text-transform: uppercase;
            font-size: 75%;
            padding: 5px 10px;
        }

        .hide {
            display: none;
        }

    </style>

    <template>

        <div id="contain">
            <div class="header">
                <input is="iron-input" id="input" bind-value="{{query}}" on-input="searchfilter" placeholder="Choose source translations">
                <paper-icon-button icon="search" on-tap="focussearch"></paper-icon-button>
            </div>

            <div class="body">
                <div class="row-header">Selected</div>
                <template is="dom-repeat" items="[[selected]]" as="source">
                    <div class$="[[rowclass(source.direction)]]">
                        <div>
                            <span>[[source.language_name]]</span> (<span>[[source.language_id]]</span>) - <span>[[source.resource_name]]</span>
                        </div>
                        <div class="buttons">
                            <paper-button raised class$="[[checkdownload(source.uptodate)]]" on-tap="download">Update</paper-button>
                            <paper-button raised on-tap="removesource">Remove</paper-button>
                        </div>
                    </div>
                </template>

                <div class="row-header">Available</div>
                <template is="dom-repeat" items="[[filtered]]" as="source">
                    <div class$="[[rowclass(source.direction)]]">
                        <div>
                            <span>[[source.language_name]]</span> (<span>[[source.language_id]]</span>) - <span>[[source.resource_name]]</span>
                        </div>
                        <div class="buttons">
                            <paper-button raised class$="[[checkavailable(source.uptodate)]]" on-tap="addsource">Select</paper-button>
                            <paper-button raised class$="[[checkdownload(source.uptodate)]]" on-tap="download">Download</paper-button>
                        </div>
                    </div>
                </template>
            </div>

            <div class="footer">
                <paper-button on-tap="cancel">Cancel</paper-button>
                <paper-button on-tap="confirm">Confirm</paper-button>
            </div>

        </div>

   </template>

</dom-module>

<script>

    Polymer({

        is: 'ts-source-modal',

        behaviors: [
            Polymer.IronResizableBehavior
        ],

        properties: {
            selected: {
                type: Array,
                value: []
            },
            available: {
                type: Array,
                value: []
            },
            filtered: {
                type: Array,
                value: []
            },
            options: {
                type: Object,
                value: {},
                notify: true
            },
            query: {
                type: String,
                value: ""
            }
        },

        sortlist: function (list) {
            return list.sort(function (a, b) {
                if (a.language_id.toLowerCase() > b.language_id.toLowerCase()) {
                    return 1;
                } else if (a.language_id.toLowerCase() < b.language_id.toLowerCase()) {
                    return -1;
                } else {
                    if (a.resource_name.toLowerCase() > b.resource_name.toLowerCase()) {
                        return 1;
                    } else if (a.resource_name.toLowerCase() < b.resource_name.toLowerCase()) {
                        return -1;
                    } else {
                        return 0;
                    }
                }
            });
        },

        focussearch: function () {
            this.$.input.focus();
        },

        rowclass: function (direction) {
            return direction === "ltr" ? 'row left' : 'row right';
        },

        checkavailable: function (uptodate) {
            return uptodate ? '' : 'hide';
        },

        checkdownload: function (uptodate) {
            return uptodate ? 'hide' : '';
        },

        searchfilter: function () {
            var query = this.query;
            var available = _.cloneDeep(this.available);
            var filtered = [];

            if (query) {
                var search = App.utils.startsWithBase.bind(null, query);
                filtered = available.filter(function(source) {
                    return search(source.language_name) || search(source.resource_name) || search(source.language_id);
                });
            } else {
                filtered = available;
            }
            this.set('filtered', filtered);
        },

        download: function (event) {
            var mythis = this;
            var source = event.model.source;

            mythis.fire('close');

            setTimeout(function() {
                mythis.set('options', {});
                mythis.set('options.body', "Downloading source data. Please wait...");
                mythis.set('options.loading', true);
                mythis.fire('iron-signal', {name: 'openloading'});

                setTimeout(function() {
                    App.dataManager.downloadProjectContainers(source.language_id, source.project_id, source.resource_id)
                        .then(function () {
                            mythis.fire('iron-signal', {name: 'opensource'});
                        })
                        .catch(function (err) {
                            console.log(err);
                            mythis.set('options.title', "Download Failed");
                            mythis.set('options.body', "Unable to download at this time.");
                            mythis.set('options.loading', false);
                        });
                }, 500);
            }, 500);
        },

        cancel: function () {
            this.query = "";
            this.fire('close');
        },

        confirm: function () {
            var sources = this.selected;
            var current = sources.length ? sources.length - 1 : null;

            this.query = "";
            this.fire('iron-signal', {name: 'updatesources', data: {sources: sources, current: current, full: true}});
            this.fire('close');
        },

        addsource: function (event) {
            var source = event.model.source;
            var index = event.model.index;
            var selected = _.cloneDeep(this.selected);

            if (selected.length < 3) {
                selected.push(source);
                this.set('selected', this.sortlist(selected));
                this.splice('available', index, 1);
                this.searchfilter();
            }
        },

        removesource: function (event) {
            var source = event.model.source;
            var index = event.model.index;
            var available = _.cloneDeep(this.available);

            available.push(source);
            this.set('available', this.sortlist(available));
            this.searchfilter();
            this.splice('selected', index, 1);
        },

        ready: function () {

        }

    });

</script>
