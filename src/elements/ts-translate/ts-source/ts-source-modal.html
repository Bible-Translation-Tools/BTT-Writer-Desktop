
<link rel="import" href="../../../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../components/paper-button/paper-button.html">
<link rel="import" href="../../../components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../components/iron-icons/iron-icons.html">
<link rel="import" href="../../../components/iron-icons/notification-icons.html">

<dom-module id="ts-source-modal">

    <style>

        :host {
            box-sizing: border-box;
            display: flex;
            flex: auto;
        }

        #contain {
            flex: auto;
            display: flex;
            flex-direction: column;
            color: var(--primary-text-color);
            overflow: hidden;
            background: var(--card-background-color);
            font-size: 110%;
        }

        [icon="search"] {
            padding: 0;
        }

        .header {
            flex: 0 0 50px;
            color: var(--secondary-text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        input {
            border: none;
            font-size: 110%;
            font-style: italic;
            width: 100%;
        }

        input:focus {
            outline: none;
        }

        #body {
            flex: auto;
            overflow-y: auto;
        }

        .row {
            display: flex;
            align-items: center;
            margin: 0;
            padding: 10px 15px;
            min-height: 40px;
            border-bottom: 1px solid var(--border-color);
        }

        .left {
            justify-content: space-between;
        }

        .right {
            justify-content: flex-end;
        }

        .buttons {
            display: flex;
            justify-content: flex-end;
            padding: 0 0 0 20px;
        }

        .row-header {
            margin: 0;
            padding: 0.25em 1em;
            background-color: var(--border-color);
            text-transform: uppercase;
            font-size: 80%;
            font-weight: 500;
            color: var(--secondary-text-color);
            display: flex;
            justify-content: space-between;
        }

        iron-icon {
            margin: 0 10px;
        }

        .footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex: 0 0 50px;
            border-top: 1px solid var(--border-color);
        }

        .footer paper-button {
            color: var(--secondary-text-color);
        }

        .footer paper-button:hover {
            color: var(--accent-color);
        }

        .buttons paper-icon-button {
            color: var(--accent-color);
        }

        paper-spinner {
            margin-right: 50px;
            --paper-spinner-layer-1-color: var(--accent-color);
            --paper-spinner-layer-2-color: var(--primary-color);
            --paper-spinner-layer-3-color: var(--accent-color);
            --paper-spinner-layer-4-color: var(--primary-color);
        }

        paper-checkbox {
            --paper-checkbox-checked-color: var(--accent-color-dark);
            --paper-checkbox-unchecked-color: var(--accent-color-dark);
        }

        .hide {
            display: none;
        }

    </style>

    <template>

        <div id="contain">
            <div class="header">
                <input is="iron-input" id="input" bind-value="{{query}}" on-input="organizeSources" placeholder="Choose source translations">
                <paper-icon-button icon="search" on-tap="focussearch"></paper-icon-button>
            </div>

            <div id="body">
                <div class="row-header">
                    <span>Selected</span>
                    <span><iron-icon icon="refresh"></iron-icon>Requires an Internet Connection<iron-icon icon="notification:wifi"></iron-icon></span>
                </div>
                <template is="dom-repeat" items="[[selected]]" as="source">
                    <div class$="[[rowclass(source.direction)]]">
                        <template is="dom-if" if="{{!source.updating}}">
                            <div>
                                <span>[[source.language_name]]</span> (<span>[[source.language_id]]</span>) - <span>[[source.resource_name]]</span>
                            </div>
                            <div class="buttons">
                                <paper-button raised class$="[[checkupdate(source.status)]]" on-tap="downloadselect">Update</paper-button>
                                <paper-checkbox checked></paper-checkbox>
                            </div>
                        </template>
                        <template is="dom-if" if="{{source.updating}}">
                            <div>
                                <span>Downloading source data. Please wait...</span>
                            </div>
                            <div>
                                <paper-spinner active></paper-spinner>
                            </div>
                        </template>
                    </div>
                </template>

                <div class="row-header">Available</div>
                <template is="dom-repeat" items="[[available]]" as="source">
                    <div class$="[[rowclass(source.direction)]]">
                        <template is="dom-if" if="{{!source.updating}}">
                            <div>
                                <span>[[source.language_name]]</span> (<span>[[source.language_id]]</span>) - <span>[[source.resource_name]]</span>
                            </div>
                            <div class="buttons">
                                <paper-checkbox></paper-checkbox>
                            </div>
                        </template>
                        <template is="dom-if" if="{{source.updating}}">
                            <div>
                                <span>Downloading source data. Please wait...</span>
                            </div>
                            <div>
                                <paper-spinner active></paper-spinner>
                            </div>
                        </template>
                    </div>
                </template>

                <div class="row-header">
                    <span>Available Online</span>
                    <span>Requires an Internet Connection<iron-icon icon="notification:wifi"></iron-icon></span>
                </div>
                <template is="dom-repeat" items="[[download]]" as="source">
                    <div class$="[[rowclass(source.direction)]]">
                        <template is="dom-if" if="{{!source.updating}}">
                            <div>
                                <span>[[source.language_name]]</span> (<span>[[source.language_id]]</span>) - <span>[[source.resource_name]]</span>
                            </div>
                            <div class="buttons">
                                <paper-icon-button icon="file-download" title="download" on-tap="downloadavail"></paper-icon-button>
                            </div>
                        </template>
                        <template is="dom-if" if="{{source.updating}}">
                            <div>
                                <span>Downloading source data. Please wait...</span>
                            </div>
                            <div>
                                <paper-spinner active></paper-spinner>
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <div class="footer">
                <paper-button on-tap="cancel">Cancel</paper-button>
                <paper-button on-tap="confirm">Confirm</paper-button>
            </div>

        </div>

   </template>

</dom-module>

<script>

    Polymer({

        is: 'ts-source-modal',

        behaviors: [
            Polymer.IronResizableBehavior
        ],

        properties: {
            master: {
                type: Array,
                value: []
            },
            selected: {
                type: Array,
                value: []
            },
            available: {
                type: Array,
                value: []
            },
            download: {
                type: Array,
                value: []
            },
            query: {
                type: String,
                value: ""
            }
        },

        focussearch: function () {
            this.$.input.focus();
        },

        rowclass: function (direction) {
            return direction === "ltr" ? 'row left' : 'row right';
        },

        checkavailable: function (status) {
            return status !== "download" ? '' : 'hide';
        },

        checkdownload: function (status) {
            return status === "download" ? '' : 'hide';
        },

        checkupdate: function (status) {
            return status === "update" ? '' : 'hide';
        },

        sortlist: function (list) {
            return list.sort(function (a, b) {
                if (a.language_id.toLowerCase() > b.language_id.toLowerCase()) {
                    return 1;
                } else if (a.language_id.toLowerCase() < b.language_id.toLowerCase()) {
                    return -1;
                } else {
                    if (a.resource_name.toLowerCase() > b.resource_name.toLowerCase()) {
                        return 1;
                    } else if (a.resource_name.toLowerCase() < b.resource_name.toLowerCase()) {
                        return -1;
                    } else {
                        return 0;
                    }
                }
            });
        },

        filterlist: function (list) {
            var query = this.query;
            var search = App.utils.startsWithBase.bind(null, query);

            if (query) {
                return list.filter(function(source) {
                    return search(source.language_name) || search(source.resource_name) || search(source.language_id);
                });
            } else {
                return list;
            }
        },

        organizeSources: function () {
            var mythis = this;
            var master = _.cloneDeep(this.master);
            var selected = [];
            var available = [];
            var download = [];

            master.forEach(function (source) {
                if (source.selected) {
                    selected.push(source);
                } else if (!source.exists) {
                    download.push(source);
                } else {
                    available.push(source);
                }
            });

            this.set('selected', this.sortlist(selected));
            this.set('available', this.sortlist(this.filterlist(available)));
            this.set('download', this.sortlist(this.filterlist(download)));

        },

        downloadavail: function (event) {
            var mythis = this;
            var source = event.model.source;
            var available = this.available;
            var index = 0;
            var buttons = mythis.querySelectorAll('paper-button');

            buttons.forEach(function (button) {
                button.disabled = true;
            });

            for (var i = 0; i < available.length; i++) {
                if (available[i].unique_id === source.unique_id) {
                    index = i;
                }
            }

            mythis.set('available.' + index + '.updating', true);
            mythis.searchfilter();

            App.dataManager.downloadProjectContainers(source.language_id, source.project_id, source.resource_id)
                .then(function () {
                    mythis.set('available.' + index + '.status', "current");
                    mythis.set('available.' + index + '.updating', false);
                    mythis.searchfilter();
                    buttons.forEach(function (button) {
                        button.disabled = false;
                    });
                })
                .catch(function (err) {
                    console.log(err);
                    mythis.set('available.' + index + '.updating', false);
                    mythis.searchfilter();
                    buttons.forEach(function (button) {
                        button.disabled = false;
                    });
                });
        },

        downloadselect: function (event) {
            var mythis = this;
            var source = event.model.source;
            var index = 0;
            var buttons = mythis.querySelectorAll('paper-button');
            var selected = _.cloneDeep(this.selected);

            buttons.forEach(function (button) {
                button.disabled = true;
            });

            for (var i = 0; i < selected.length; i++) {
                if (selected[i].unique_id === source.unique_id) {
                    index = i;
                }
            }

            selected[index].updating = true;
            mythis.set('selected', []);
            mythis.set('selected', selected);

            App.dataManager.downloadProjectContainers(source.language_id, source.project_id, source.resource_id)
                .then(function () {
                    selected[index].status = "current";
                    selected[index].updating = false;
                    mythis.set('selected', []);
                    mythis.set('selected', selected);
                    buttons.forEach(function (button) {
                        button.disabled = false;
                    });
                })
                .catch(function (err) {
                    console.log(err);
                    mythis.set('selected.' + index + '.updating', false);
                    buttons.forEach(function (button) {
                        button.disabled = false;
                    });
                });
        },

        cancel: function () {
            this.query = "";
            this.fire('close');
        },

        confirm: function () {
            var sources = this.selected;
            var current = sources.length ? sources.length - 1 : null;

            this.query = "";
            this.fire('iron-signal', {name: 'updatesources', data: {sources: sources, current: current, full: true}});
            this.fire('close');
        },

        addsource: function (event) {
            var source = event.model.source;
            var available = this.available;
            var index = 0;
            var selected = _.cloneDeep(this.selected);

            for (var i = 0; i < available.length; i++) {
                if (available[i].unique_id === source.unique_id) {
                    index = i;
                }
            }

            if (selected.length < 3) {
                selected.push(source);
                this.set('selected', this.sortlist(selected));
                this.splice('available', index, 1);
                this.searchfilter();
            }
        },

        removesource: function (event) {
            var source = event.model.source;
            var index = event.model.index;
            var available = _.cloneDeep(this.available);

            available.push(source);
            this.set('available', this.sortlist(available));
            this.searchfilter();
            this.splice('selected', index, 1);
        },

        ready: function () {

        }

    });

</script>
