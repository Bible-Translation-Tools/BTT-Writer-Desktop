
<link rel="import" href="../../../components/iron-list/iron-list.html">
<link rel="import" href="../../../components/paper-checkbox/paper-checkbox.html">

<dom-module id="ts-source-modal">

    <style>

        :host {
            box-sizing: border-box;
            display: flex;
            flex: auto;
        }

        #contain {
            flex: auto;
            display: flex;
            flex-direction: column;
            color: var(--primary-text-color);
            overflow: hidden;
            background: var(--card-background-color);
        }

        [icon="search"] {
            padding: 0;
        }

        .header {
            flex: 0 0 56px;
            border-bottom: 1px solid var(--border-color);
            color: var(--secondary-text-color);
            font-style: italic;
            font-size: 110%;
            display: flex;
        }

        .header div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-background-color);
            width: 100%;
        }

        input {
            border: none;
            font-size: 110%;
            font-style: italic;
            width: 100%;
        }

        input:focus {
            outline: none;
        }

        .body {
            flex: auto;
            overflow-y: auto;
        }

        .selected-list {
            font-size: 110%;
        }

        .row {
            display: block;
            margin: 0;
            padding: 1em;
            border-bottom: 1px solid var(--border-color);
        }

        .row:hover {
            background: var(--accent-color-light);
            box-shadow: inset 0 -1px rgba(0,0,0,0);
        }

        .row-header {
            display: block;
            margin: 0;
            padding: 0.25em 1em;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--border-color);
            text-transform: uppercase;
            font-size: 80%;
            font-weight: 500;
            color: var(--secondary-text-color);
        }

        .right {
            float: right;
        }

        .clickable {
            cursor: pointer;
        }

        .footer {
            width: 100%;
            flex: 0 0 56px;
            border-top: 1px solid var(--border-color);
        }

        paper-button {
            margin-top: 0.6rem;
            color: var(--secondary-text-color);
        }

        paper-button:hover {
            color: var(--accent-color);
        }

        ::-webkit-scrollbar {
            display: none;
        }

        paper-checkbox {
            --paper-checkbox-checked-color: var(--accent-color-dark);
            --paper-checkbox-unchecked-color: var(--accent-color-dark);
        }

        paper-checkbox[disabled]::shadow #checkbox.paper-checkbox {
            opacity: 1;
        }

    </style>

    <template>

        <div id="contain">
            <div class="header">
                <div>
                    <input is="iron-input" bind-value="{{query}}" placeholder="Choose source translations">
                    <paper-icon-button class="right" icon="search" title="Search Languages"></paper-icon-button>
                </div>
            </div>

            <div class="body">
                <div id="selected-sources-header" class="row-header">Selected</div>
                <template is="dom-repeat" items="[[sources]]" as="source">
                    <div class="row clickable" data-element="[[source]]" data-index="[[index]]" on-tap="removesource">
                        <span>[[source.ln]]</span> - <span>[[source.name]]</span>
                        <paper-checkbox class="right" disabled checked style="opacity: 1;"></paper-checkbox>
                    </div>
                </template>

                <div id="available-sources-header" class="row-header">Available</div>
                <template is="dom-repeat" items="{{searchfilter(query, available)}}" as="source">
                    <div class="row clickable" data-element="[[source]]" data-index="[[index]]" on-tap="addsource">
                        <span>[[source.ln]]</span> - <span>[[source.name]]</span>
                        <paper-checkbox class="right" disabled style="opacity: 1;"></paper-checkbox>
                    </div>
                </template>
            </div>

            <div class="footer">
                <paper-button class="right" on-tap="confirm">Confirm</paper-button>
                <paper-button class="right" on-tap="cancel">Cancel</paper-button>
            </div>

        </div>

   </template>

</dom-module>

<script>

    Polymer({

        is: 'ts-source-modal',

        behaviors: [
            Polymer.IronResizableBehavior
        ],

        properties: {
            allSources: {
                type: Array,
                value: []
            },
            sources: {
                type: Array,
                value: []
            },
            available: {
                type: Array,
                value: []
            },
            selectedSource: {
                type: Number,
                value: null
            },
            query: {
                type: String,
                value: ""
            }
        },

        observers: [
            'updateavailable(allSources.*, sources.*)'
        ],

        searchfilter: function(query, available) {
            if (query) {
                var search = App.util.startsWithBase.bind(null, query);
                return available.filter(function(source) {
                    return search(source);
                });
            } else {
                return available;
            }
        },

        updateavailable: function() {
            var all = this.allSources;
            var selected = this.sources;
            var available = [];
            var check;

            for (var i = 0; i < all.length; i++) {
                check = false;
                for (var j = 0; j < selected.length; j++) {
                    if (all[i].id === selected[j].id) {
                        check = true;
                    }
                }
                if (!check) {
                    available.push(all[i]);
                }
            }
            this.set('available', available);
        },

        cancel: function() {
            this.fire('close');
        },

        confirm: function() {
            var sources = this.sources;
            var selected = this.selectedSource;
            this.fire('iron-signal', {name: 'updatesources', data: {sources: sources, selected: selected}});
            this.fire('close');
        },

        addsource: function(event) {
            var elem = event.target.dataElement;
            this.push('sources', elem);
            this.selectedSource = this.sources.indexOf(elem);
        },

        removesource: function(event) {
            var index = event.target.dataIndex;
            this.splice('sources', index, 1);
            if (this.selectedSource === index) {
                if (this.sources.length === 0) {
                    this.selectedSource = null;
                }
                else if (index >= this.sources.length - 1) {
                    this.selectedSource = (this.sources.length - 1);
                }
            }
            else if (index < this.selectedSource) {
                this.selectedSource -= 1;
            }
        },

        ready: function () {

        }
    });

</script>
