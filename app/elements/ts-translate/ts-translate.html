
<link rel="import" href="../../components/iron-signals/iron-signals.html">

<link rel="import" href="./ts-read-mode/ts-read-mode.html">
<link rel="import" href="./ts-chunk-mode/ts-chunk-mode.html">
<link rel="import" href="./ts-review-mode/ts-review-mode.html">
<link rel="import" href="./ts-translate-sidebar.html">
<link rel="import" href="./ts-nosource-mode.html">

<dom-module id="ts-translate">

    <style>

        :host {
            display: flex;
        }

        #pages {
            flex: auto;
            display: flex;
            position: relative;
        }

    </style>

    <template>

        <ts-translate-sidebar selected="{{selected}}" on-gohome="gohome" on-gopublish="gopublish" on-gosettings="gosettings"></ts-translate-sidebar>

        <div id="pages">
            <ts-read-mode id="readmode" chapters="[[chapters]]" modestatus="{{modestatus}}"></ts-read-mode>
            <ts-chunk-mode id="chunkmode" chunks="{{chunks}}" modestatus="{{modestatus}}"></ts-chunk-mode>
            <ts-review-mode id="reviewmode" chunks="{{chunks}}" modestatus="{{modestatus}}"></ts-review-mode>
            <ts-nosource-mode id="nosourcemode" projectdata="{{currentproject.data}}"></ts-nosource-mode>
        </div>

        <iron-signals on-iron-signal-frompublish="frompublish"></iron-signals>
        <iron-signals on-iron-signal-updatesources="updatesources"></iron-signals>
        <iron-signals on-iron-signal-updateselected="updateselected"></iron-signals>
        <iron-signals on-iron-signal-loadnewproject="loadnewproject"></iron-signals>
        <iron-signals on-iron-signal-loadproject="loadproject"></iron-signals>
        <iron-signals on-iron-signal-updatetranslation="updatetranslation"></iron-signals>

    </template>

</dom-module>

<script>

    Polymer({

        is: 'ts-translate',

        behaviors: [
            Polymer.IronResizableBehavior,
            Polymer.NeonAnimatableBehavior
        ],

        properties: {
            selected: {
                type: Number,
                value: 0,
                observer: 'modechange'
            },
            route: {
                type: String,
                value: '',
                notify: true
            },
            currentproject: {
                type: Object,
                value: {},
                notify: true
            },
            modestatus: {
                type: Object,
                value: {}
            },
            backto: {
                type: String,
                value: "",
                notify: true
            },
            chapters: {
                type: Object,
                value: {}
            },
            chunks: {
                type: Object,
                value: {}
            },
            animationConfig: {
                value: function () {
                    return {
                        'entry': {
                            name: 'slide-from-right-animation',
                            node: this
                        },
                        'exit': {
                            name: 'slide-right-animation',
                            node: this
                        }
                    }
                }
            }
        },

        forceResize: function () {
            this.$.readmode.notifyResize();
            this.$.chunkmode.notifyResize();
            this.$.reviewmode.notifyResize();
        },

        loadnewproject: function (event, data) {
            console.log("loadnewproject translate");
            this.set('currentproject.translation', data.translation);
            this.set('currentproject.data', data.projdata);
            this.savetofile();
            this.reset();
            this.checksources();
        },

        loadproject: function (event, data) {
            console.log("loadproject translate");
            var mythis = this;
            this.set('currentproject.translation', data.translation);
            this.set('currentproject.data', data.projdata);
            this.reset();
            this.changesource();
            this.checksources();
            setTimeout(function() {
                mythis.fire('iron-signal', {name: 'adjustbar'});
            }, 500);
        },

        updatesources: function (event, data) {
            console.log("updatesources translate");
            var mythis = this;
            this.set('currentproject.data.sources', data.sources);
            this.set('currentproject.data.currentsource', data.selected);
            this.savetofile();
            this.changesource();
            this.checksources();
            setTimeout(function() {
                mythis.fire('iron-signal', {name: 'adjustbar'});
            }, 250);
        },

        updateselected: function (event, data) {
            var mythis = this;
            console.log("updateselected translate");
            this.set('currentproject.data.currentsource', data.selected);
            this.savetofile();
            this.changesource();
            setTimeout(function() {
                mythis.fire('iron-signal', {name: 'adjustbar'});
            }, 250);
        },

        updatetranslation: function () {
            console.log("updatetranslation translate");
            this.upload();
            this.savetofile();
            this.changesource();
        },

        savetofile: function () {
            console.log("savetofile translate");
            var mythis = this;
            App.projectsManager.saveTargetTranslation(this.currentproject.translation, this.currentproject.data).then(function() {
                mythis.fire('iron-signal', {name: 'updatelist'});
            });
        },

        changesource: function () {
            var current = this.currentproject.data.currentsource;
            if (current === null || current === undefined) {
                return;
            }
            console.log("changesource translate");
            var currentsource = this.currentproject.data.sources[current];
            var frames = App.projectsManager.getSourceFrames(currentsource);
            var name = this.currentproject.data.project.name;
            var source = [];
            var srcchunk = {};
            var i;
            var chap;
            var sourcedata;
            var startstr = '<verse number="';
            var endstr = '" style="v" />';
            var test = new RegExp(startstr);
            var verse;
            var lowest;
            var highest;

            for (i = 0; i < frames.length; i++) {
                chap = parseInt(frames[i].chapter);
                sourcedata = frames[i].chunk;
                lowest = 0;
                highest = 0;
                while (test.test(sourcedata)) {
                    verse = parseInt(sourcedata.substring(sourcedata.search(startstr) + 15, sourcedata.search(endstr)));
                    if (lowest === 0) {
                        lowest = verse;
                    }
                    if (highest < verse) {
                        highest = verse;
                    }
                    sourcedata = sourcedata.replace(startstr, " /v");
                    sourcedata = sourcedata.replace(endstr, " ");
                }

                srcchunk = {
                    meta: {
                        chapter: chap,
                        startverse: lowest,
                        endverse: highest
                    },
                    content: sourcedata,
                    notes: 'Notes for ' + name + ' chapter ' + chap + ' verse ' + lowest,
                    words: 'Words for ' + name + ' chapter ' + chap + ' verse ' + lowest
                };
                source.push(srcchunk);
            }
            this.set('currentproject.source', source);
            this.createchunks();
            this.createchapters();
            var mythis = this;
            setTimeout(function() {
                mythis.forceResize();
            }, 200);
        },

        modechange: function (tomode, frommode) {
            console.log("modechange translate", tomode, frommode);
            var read = this.$.readmode;
            var chunk = this.$.chunkmode;
            var review = this.$.reviewmode;
            var nosource = this.$.nosourcemode;

            if (frommode > 0) {
                this.set('modestatus.lastmode', frommode);
            }

            if (frommode === 1) {
                read.frommode();
            } else if (frommode === 2) {
                chunk.frommode();
            } else if (frommode === 3) {
                review.frommode();
            } else if (frommode === 4) {
                nosource.frommode();
            }

            if (tomode === 1) {
                read.tomode();
            } else if (tomode === 2) {
                chunk.tomode();
            } else if (tomode === 3) {
                review.tomode();
            } else if (tomode === 4) {
                nosource.tomode();
            }
        },

        reset: function () {
            console.log("reset translate");
            var mythis = this;
            var read = this.$.readmode;
            var chunk = this.$.chunkmode;
            var review = this.$.reviewmode;
            var nosource = this.$.nosourcemode;
            var sources = this.currentproject.data.sources;

            mythis.set('selected', 0);
            mythis.set('modestatus', {"chapter": 1, "verse": 1, "lastmode": 1});
            read.classList.add("hide");
            chunk.classList.add("hide");
            review.classList.add("hide");
            nosource.classList.add("hide");
            mythis.fire('iron-signal', {name: 'reset'});

            if (sources !== undefined && sources.length !== 0) {
                setTimeout(function() {
                    mythis.set('selected', 1);
                }, 500);
            }
        },

        checksources: function () {
            console.log("checksources translate");
            var mythis = this;
            var sources = this.currentproject.data.sources;
            var lastmode = this.modestatus.lastmode;
            var selected = this.selected;

            if (selected === 4) {
                if (sources !== undefined && sources.length !== 0) {
                    mythis.set('selected', lastmode);
                }
            } else {
                if (sources === undefined || sources.length === 0) {
                    setTimeout(function() {
                        mythis.set('selected', 4);
                    }, 500);
                }
            }
        },

        upload: function () {
            console.log("upload translate");
            var update = this.chunks.data.map(function(chunk){
                return {meta: chunk.meta, content: chunk.transcontent, status: chunk.status};
            });
            var count = 0;
            for (var i = 0; i < update.length; i++) {
                if (update[i].status === "Complete") {
                    count++;
                }
            }
            var completion = Math.round((count / update.length) * 100);
            this.set('currentproject.data.completion', completion);
            this.set('currentproject.translation', update);
        },

        createchunks: function () {
            console.log("createchunks translate");
            var transdata = {};
            var srcdata = {};
            var translation = this.currentproject.translation;
            var source = this.currentproject.source;
            var projectdata = this.currentproject.data;

            transdata.data = translation.map(function(chunk){
                return {transcontent: chunk.content, status: chunk.status, data: projectdata};
            });
            srcdata.data = source.map(function(chunk){
                return {srccontent: chunk.content, meta: chunk.meta, notes: chunk.notes, words: chunk.words};
            });
            var merged = _.merge(srcdata, transdata);
            this.set('chunks', merged);
        },

        createchapters: function () {
            console.log("createchapters translate");
            var transdata = {};
            var srcdata = {};
            var transchapters = [];
            var srcchapters = [];
            var translation = this.currentproject.translation;
            var source = this.currentproject.source;
            var projectdata = this.currentproject.data;

            _.forEach(_.groupBy(translation, function(chunks) {
                return chunks.meta.chapter;
            }), function (data, chap) {
                var chapstatus = "Complete";
                var chapcontent = "";

                _.forEach(data, function (chunk) {
                    if (chunk.status === "Incomplete") {
                        chapstatus = "Incomplete";
                    }
                    chapcontent += chunk.content + " ";
                });
                transchapters.push({status: chapstatus, transcontent: chapcontent, data: projectdata});
            });

            _.forEach(_.groupBy(source, function(chunks) {
                return chunks.meta.chapter;
            }), function (data, chap) {
                var chapcontent = "";
                var chapter = parseInt(chap);

                _.forEach(data, function (chunk) {
                    chapcontent += chunk.content + " ";
                });
                srcchapters.push({chapter: chapter, srccontent: chapcontent});
            });

            transdata.data = transchapters;
            srcdata.data = srcchapters;
            var merged = _.merge(srcdata, transdata);
            this.set('chapters', merged);
        },

        frompublish: function (event, data) {
            this.selected = 0;
            this.set('modestatus.chapter', data.chapter);
            this.set('modestatus.verse', data.verse);
            this.route = "translate";
            this.selected = 3;
        },

        gohome: function () {
            this.animationConfig.exit.name = 'slide-right-animation';
            this.animationConfig.entry.name = 'slide-from-right-animation';
            this.fire('iron-signal', {name: 'setdefault'});
            this.route = "home";
        },

        gopublish: function () {
            if(this.currentproject.data.sources.length && this.currentproject.translation[0].meta.startverse > 0) {
                this.animationConfig.exit.name = 'slide-left-animation';
                this.animationConfig.entry.name = 'slide-from-left-animation';
                this.fire('iron-signal', {name: 'updatepublish'});
                this.route = "publish";
                this.selected = 1;
            }
        },

        gosettings: function () {
            this.animationConfig.exit.name = 'slide-left-animation';
            this.animationConfig.entry.name = 'slide-from-left-animation';
            this.backto = this.route;
            this.route = "settings";
        },

        ready: function() {

        }

    });

</script>
