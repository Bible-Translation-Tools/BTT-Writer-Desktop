
<link rel="import" href="../../components/neon-animation/neon-animation.html">
<link rel="import" href="../../components/paper-material/paper-material.html">
<link rel="import" href="../../components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="./ts-source/ts-source-tab.html">
<link rel="import" href="./ts-read-mode/ts-read-mode.html">
<link rel="import" href="./ts-chunk-mode/ts-chunk-mode.html">
<link rel="import" href="./ts-review-mode/ts-review-mode.html">
<link rel="import" href="./ts-translate-sidebar.html">

<dom-module id="ts-translate">

    <style>

        :host {
            display: flex;
        }

        neon-animated-pages {
            flex: auto;
            display: flex;
        }

        neon-animated-pages > * {
            flex: auto;
        }

        .hide {
            display: none;
        }

        paper-material {
            background: white;
        }

        #heading {
            padding: 5px 1em;
            color: var(--greyed-out-dark);
            display: flex;
            justify-content: space-between;
            min-height: 75px;
            align-items: center;
            font-size: 125%;
        }

        #newpage {
            flex: auto;
            display: flex;
            flex-direction: column;
        }

        #newpage.hide {
            display: none;
        }

        #topbox {
            margin: 15px 40px 15px 15px;
            position: relative;
        }

        #bottombox {
            flex: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--greyed-out-dark);
            font-style: italic;
            font-size: 110%;
        }

        #bottomcard {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
            top: 25px;
            left: 25px;
            background-size: 100% 32px;
            background-image: -webkit-linear-gradient(white 27px, var(--greyed-out-light) 27px, var(--greyed-out-light) 28px, white 28px);
        }

        #topcard {
            z-index: 2;
        }

        .hide {
            display: none;
        }

        .big {
            --iron-icon-height: 100px;
            --iron-icon-width: 100px;
        }

    </style>

    <template>

        <ts-translate-sidebar route="{{route}}" selected="{{selected}}"></ts-translate-sidebar>

        <neon-animated-pages id="pages" selected="[[selected]]" exit-animation="scale-down-animation" entry-animation="scale-up-animation">
            <ts-read-mode project="{{project}}" chapters="[[chapters]]"></ts-read-mode>
            <ts-chunk-mode project="{{project}}" chunks="{{chunks}}" on-modetrigger="upload"></ts-chunk-mode>
            <ts-review-mode project="{{project}}" chunks="{{chunks}}" on-modetrigger="upload"></ts-review-mode>
        </neon-animated-pages>

        <div id="newpage">
            <div id="topbox">
                <paper-material id="topcard" elevation="1">
                    <div id="heading">
                        <div>
                            Project: <span>[[project.name]]</span> - <span>[[project.language]]</span>
                        </div>
                        <ts-source-tab id="sourcetab" sources="{{project.sources}}" selected-source="{{project.currentsource}}"></ts-source-tab>
                    </div>
                </paper-material>
                <paper-material id="bottomcard" elevation="1">
                </paper-material>
            </div>
            <div id="bottombox">
                <p>Choose source translation(s) to begin reading and translating</p>
                <paper-icon-button icon="tab" class="big" on-tap="openmodal"></paper-icon-button>
            </div>
        </div>

    </template>

</dom-module>

<script>

    Polymer({

        is: 'ts-translate',

        behaviors: [
            Polymer.IronResizableBehavior
        ],

        properties: {
            selected: {
                type: Number,
                value: 0
            },
            route: {
                type: String,
                value: '',
                notify: true
            },
            project: {
                type: Object,
                value: {},
                notify: true
            },
            chapters: {
                type: Object,
                value: {},
                computed: 'createchapters(project.source.*, project.translation.*)'
            },
            chunks: {
                type: Object,
                value: {},
                computed: 'createchunks(project.source.*, project.translation.*)'
            }
        },

        observers: [
            'onSelectedSourceChanged(project.currentsource)',
            'reset(project.name)',
            'checksources(project.sources)'
        ],

        openmodal: function () {
            this.$.sourcetab.openModal();
        },

        reset: function () {
            this.selected = 0;
        },

        checksources: function () {
            var array = this.project.sources;
            var pages = this.$.pages;
            var newpage = this.$.newpage;
            if (array === undefined || array.length === 0) {
                pages.classList.add("hide");
                newpage.classList.remove("hide");
            } else {
                pages.classList.remove("hide");
                newpage.classList.add("hide");
            }
        },

        upload: function () {
             var update = this.chunks.data.map(function(chunk){
             return {meta: chunk.meta, content: chunk.transcontent, status: chunk.status};
             });

            var count = 0;

            for (var i = 0; i < update.length; i++) {
                if (update[i].status === "Complete") {
                    count++;
                }
            }

            var completion = Math.round((count / update.length) * 100);
            this.set('project.completion', completion);
            this.set('project.translation', update);
        },

        createchunks: function () {
            var transdata = {};
            var srcdata = {};
            var translation = this.project.translation;
            var source = this.project.source;

            transdata.data = translation.map(function(chunk){
                return {transcontent: chunk.content, status: chunk.status};
            });

            srcdata.data = source.map(function(chunk){
                return {srccontent: chunk.content, meta: chunk.meta, notes: chunk.notes, words: chunk.words};
            });

            return _.merge(srcdata, transdata);
        },

        createchapters: function () {
            var transdata = {};
            var srcdata = {};
            var transchapters = [];
            var srcchapters = [];
            var translation = this.project.translation;
            var source = this.project.source;

            _.forEach(_.groupBy(translation, function(chunks) {
                return chunks.meta.chapter;
            }), function (data, chap) {
                var chapstatus = "Complete";
                var chapcontent = "";

                _.forEach(data, function (chunk) {
                    if (chunk.status === "Incomplete") {
                        chapstatus = "Incomplete";
                    }
                    chapcontent += chunk.content + " ";
                });
                transchapters.push({status: chapstatus, transcontent: chapcontent});
            });

            _.forEach(_.groupBy(source, function(chunks) {
                return chunks.meta.chapter;
            }), function (data, chap) {
                var chapcontent = "";

                _.forEach(data, function (chunk) {
                    chapcontent += chunk.content + " ";
                });
                srcchapters.push({chapter: chap, srccontent: chapcontent});
            });

            transdata.data = transchapters;
            srcdata.data = srcchapters;

            return _.merge(srcdata, transdata);
        },

        onSelectedSourceChanged: function(newValue) {

            if (newValue != null && newValue >= 0) {
                // The paper-tab won't get programmatically selected until after 30ms
                this.async(function() {
                    var source = document.querySelector('paper-tab.iron-selected').innerText;

                    //
                    // Write code to get new data based on source tab selection here...
                    //

                }, 30);
            }
        },

        ready: function() {

        }

    });

</script>
