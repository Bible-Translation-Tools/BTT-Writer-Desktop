<!-- ts-read-mode -->

<!-- Used in <ts-dashboard> -->

<link rel="import" href="../../components/paper-card/paper-card.html">
<link rel="import" href="../../components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../components/iron-pages/iron-pages.html">
<link rel="import" href="../../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../components/iron-icons/iron-icons.html">
<link rel="import" href="../../components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="ts-translation-sources.html">

<dom-module id="ts-read-mode">

	<style is="custom-style">

		:host {
         display: flex;
      }
        .main {
			display: block;
			overflow-y: auto;
			box-sizing: border-box;
            flex: auto;
		}
		.container {
			display: block;
			width: 100%;
			height: 100%;
			position: relative;
			z-index: 0;
			box-sizing: border-box;
			padding: 20px 20px 0;
		}
		.card-sets {
			width: 100%;
			position: relative;
			margin-bottom: 40px;
		}
		paper-card {
			width: calc(100% - 20px);
		}
		.top-card {
			position: relative;
			z-index: 1;
		}
		.bottom-card {
			position: absolute;
			top: 20px;
			right: 0;
			background-color: #EEE;
			cursor: pointer;
			transition: all 0.15s ease-out;
		}
		.bottom-card:hover {
			right: -3px;
			top: 25px;
		}
		.card-heading {
			padding: 0.75rem 0;
			text-align: center;
		}
		.tabs-hole {
			display: block;
			width: 100;
			height: 3rem;
			/*background-color: #444;*/
		}
		.card-heading h3 {
			margin: 0;
			padding: 0;
			color: #888;
		}
		.card-content {
			width: 60%;
			margin: 0 auto;
			padding-top: 0.75rem;
		}
		.card-content p {
			line-height: 1.8;
			margin-top: 0;
		}
		.hidden {
			visibility: hidden;
		}

		paper-tabs {
			--paper-tabs-selection-bar-color: #AAA;
			--paper-tabs: {
				padding: 0.75rem 0;
				height: 1.5rem;
			}
		}
		paper-tab {
			--paper-tab: {
				padding: 0;
				margin: 0 0.5rem;
				color: #AAA;
				font-weight: 300;
			}
		}
		paper-tab:focus {
			--paper-tab: {
				color: red;
				font-weight: 300;
			}
		}
		.icon-container {
			height: 48px;
			width: 48px;
			display: inline-block;
			float: right;
		}
		.tabs-container {
			width: calc(100% - 60px);
			position: absolute;
			top: 40px;
			left: 20px;
			z-index: 100;
			margin: 0;
		}
		.tabs-container.animate {
			transition: all 0.15s ease-out;
		}
		.tabs-container.sticky {
			width: calc(100% - 127px);
			position: fixed;
			top: 40px;
			left: 70px;
			background-color: #EEE;
		}
		#source-tabs {
			text-align: center;
		}
		#source-tabs::shadow #tabsContent {
			position: relative;
		}
		.icon {
			position: relative;
			top: 50%;
			left: 50%;
			-webkit-transform: translate(-50%, -50%);
			--moz-transform: translate(-50%, -50%);
			transform: translate(-50%, -50%);
			cursor: pointer;
			color: #CCC;
		}

        .overflow {
            background: var(--primary-color-dark);
            color: white;
            min-width: 50px;
            align-self: stretch;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .overflow>div {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .overflow paper-icon-button {
            padding-bottom: 15px;
        }

        .overflow a {
            color: #B7E1DF;
        }

        .overflow a.current {
            color: white;
        }

	</style>

	<template>

        <div class="overflow">
            <div>
                <a href="/chaptermenu" class="current"><paper-icon-button icon="arrow-back" title="Go Back"></paper-icon-button></a>
                <a href="/readmode" class="current"><paper-icon-button icon="assignment" title="Read Mode"></paper-icon-button></a>
                <a href="/readmode"><paper-icon-button icon="flip-to-front" title="Chunk Mode"></paper-icon-button></a>
                <a href="/reviewmode"><paper-icon-button icon="assignment-turned-in" title="Review Mode"></paper-icon-button></a>
            </div>
            <div>
                <a href="/publishbook" class="current"><paper-icon-button icon="more-vert" title="more options"></paper-icon-button></a>
            </div>
        </div>

        <div id="cue" class="main sticky-cue">

            <ts-translation-sources opened="{{openedTranslations}}"></ts-translation-sources>

				<div class="container">

					<div id="cardsets" class="tabs-container card-sets sticky-ele">
						<div class="icon-container">
							<iron-icon icon="icons:tab" class="icon24 icon" on-click="showSources"></iron-icon>
						</div>
						<paper-tabs id="source-tabs" selected="{{ selected }}" noink scrollable hide-scroll-buttons>
		               <template is="dom-repeat" items="{{ tabs }}" as="tab">
		                  <paper-tab class="source-tab">{{ tab.translation.title }}</paper-tab>
		               </template>
		         	</paper-tabs>
					</div>

					<div>
						<iron-pages id="source-pages" selected="[[ selected ]]">
							<template is="dom-repeat" items="{{ tabs }}" as="tab">
								<div class="source-page">
									<template is="dom-repeat" items="{{ tab.content }}" as="chapter" indexAs="index">
										<div class="card-sets">
											<paper-card class="card top-card" elevation="2" >
												<div class="tabs-hole"></div>
												<div class="card-heading">
													<h3>
														<span>{{ tab.book_title }}</span> <span>{{ chapter.chapter }}</span>
													</h3>
												</div>
												<div class="card-content">
													<p>{{ chapter.text }}</p>
												</div>
											</paper-card>
										</div>
									</template>
								</div>
							</template>
						</iron-pages>
					</div>

				</div>

        </div>

	</template>

</dom-module>

<script>

(function() {

	// Function:
	// function findPos(obj) {
	// 	var curtop = 0;

	// 	if (obj.offsetParent) {
	// 		do {
	// 			curtop += obj.offsetTop;
	// 		} while (obj = obj.offsetParent);
	// 	}

	// 	return curtop;
	// }

	// Function: Compile the tops and heights of cards in the active iron-page
	function getCardPos(obj) {
		var cards = obj.querySelectorAll('.iron-selected > .card-sets');

		var tops = [];
		var heights = [];

		for (i = 0; i < cards.length; i++) {
			tops.push(cards[i].offsetTop);
			heights.push(cards[i].offsetHeight);
		}

		return {'tops': tops, 'heights': heights};
	}

	// Function: Calculate the trigger points to stick or move the tabs
	function getTabPos(obj) {

		var tops = obj.cardPos.tops,
			heights = obj.cardPos.heights,
			current = obj.tabPos.current,
			stickyAt = obj.tabPos.stickyAt,
			forwardTrigger = obj.tabPos.forwardTrigger,
			forwardTo = obj.tabPos.forwardTo,
			backwardTrigger = obj.tabPos.backwardTrigger,
			backwardTo = obj.tabPos.backwardTo,

		stickyAt = tops[current];
		forwardTrigger = heights[current]*0.6 + tops[current];
		forwardTo = tops[current+1];
		if (current === 0) {
			backwardTrigger = -1;
			backwardTo = -1;
		} else if (current > 0 && current < tops.length) {
			backwardTrigger = heights[current-1]*0.6 + tops[current-1];
			backwardTo = tops[current-1];
		}

		return {
			'current': current,
			'stickyAt': stickyAt,
			'forwardTrigger': forwardTrigger,
			'forwardTo': forwardTo,
			'backwardTrigger': backwardTrigger,
			'backwardTo': backwardTo
		}
	}

	Polymer({

		is: 'ts-read-mode',

        behaviors: [
            Polymer.IronResizableBehavior
        ],

		properties: {

			title: {
				type: String,
				value: 'John'
			},

			openedTranslations: {
				type: Array,
				value: []
			},

			selected: {
				type: String,
				value: '0'
			},

			tabs: {
				type: Array,
				value: [
					{
						translation: {
							code: 'ulb',
							title: 'English ULB'
						},
						book_title: 'John',
						content: [
							{
								chapter: 1,
								text: 'In the beginning was the Word, and the Word was with God, and the Word was God. The same was in the beginning with God. All things were made by him; and without him was not any thing made that was made.'
							},
							{
								chapter: 2,
								text: 'And the Word was made flesh, and dwelt among us, (and we beheld his glory, the glory as of the only begotten of the Father,) full of grace and truth. John bare witness of him, and cried, saying, This was he of whom I spake, He that cometh after me is preferred before me: for he was before me.'
							},
							{
								chapter: 3,
								text: 'They came and saw where he dwelt, and abode with him that day: for it was about the tenth hour.'
							}
						]
					},
					{
						translation: {
							code: 'udb',
							title: 'English UDB'
						},
						book_title: 'Josh',
						content: [
							{
								chapter: 1,
								text: 'And the Word was made flesh, and dwelt among us, (and we beheld his glory, the glory as of the only begotten of the Father,) full of grace and truth. John bare witness of him, and cried, saying, This was he of whom I spake, He that cometh after me is preferred before me: for he was before me.'
							},
							{
								chapter: 2,
								text: 'In the beginning was the Word, and the Word was with God, and the Word was God. The same was in the beginning with God. All things were made by him; and without him was not any thing made that was made.'
							},
							{
								chapter: 3,
								text: 'They came and saw where he dwelt, and abode with him that day: for it was about the tenth hour.'
							}
						]
					}
				]
			},

			cardPos: {
				type: 'Object',
				value: {
					tops: [],
					heights: []
				}
			},

			tabPos: {
				type: 'Object',
				value: {
					current: 0,
					stickyAt: 0,
					forwardTrigger: 0,
					forwardTo: 0,
					backwardTrigger: 0,
					backwardTo: 0
				}
			},
		},

		// Function that runs when ts-read-mode is attached to the DOM
		attached: function() {

			var cue = this.$.cue,
				stick = this.stickEle.bind(this),
				calc = this.recalcCardTabPos.bind(this),
				scrollEvent = (/Firefox/i.test(navigator.userAgent))? 'DOMMouseScroll' : 'mousewheel';

			['scroll', scrollEvent].forEach(function(e) {
				cue.addEventListener(e, stick);
			});

			this.$['source-tabs'].addEventListener('iron-select', calc);

			var sourcesModal = document.querySelector('ts-translation-sources');
			sourcesModal.display = 'none';
		},

		// Function that runs when ts-read-mode is displayed
		attributeChanged: function() {
			this.async(function() {
				this.recalcCardTabPos();
			}, 100);
		},

		// Function that got called when tabs are moved or another translation selected
		recalcCardTabPos: function() {
			this.cardPos = getCardPos(this);
			this.tabPos = getTabPos(this);
			this.stickEle();
		},

		showSources: function() {
			var sourcesModal = document.querySelector('ts-translation-sources');
			sourcesModal.style.display = 'block';
			sourcesModal.fire('open');
			document.querySelector('iron-list').fire('resize');
		},

 		// Function that got called with every scroll move
		stickEle: function(event) {
			var cue = this.$.cue,
				cardsets = this.$.cardsets,
				current = this.tabPos.current,
				stickyAt = this.tabPos.stickyAt,
				forwardTrigger = this.tabPos.forwardTrigger,
				forwardTo = this.tabPos.forwardTo,
				backwardTrigger = this.tabPos.backwardTrigger,
				backwardTo = this.tabPos.backwardTo;

			// Determine whether tabs should stick or not
			if (cue.scrollTop > stickyAt) {
				cardsets.style.top = '40px';
				cardsets.classList.add('sticky');
			} else if (cue.scrollTop <= stickyAt) {
				cardsets.classList.remove('sticky');
				cardsets.style.top = String(this.cardPos.tops[current]) + 'px';
			}

			// Determine wether tabs should jump forward or backward
			if (cue.scrollTop > forwardTrigger) {
				cardsets.classList.remove('sticky');
				cardsets.classList.add('animate');
				cardsets.style.top = String(forwardTo) + 'px';
				this.tabPos.current += 1;
				this.tabPos = getTabPos(this);
				window.setTimeout(function() {cardsets.classList.remove('animate');}, 150);
			} else if (cue.scrollTop <= backwardTrigger) {
				cardsets.classList.add('animate');
				cardsets.style.top = '40px';
				cardsets.classList.add('sticky');
				this.tabPos.current -= 1;
				this.tabPos = getTabPos(this);
				window.setTimeout(function() {cardsets.classList.remove('animate');}, 150);
			}
		},

		ready: function() {
			this.async(function() {

				this.selected = 0;

			}, 1);

		}
	});

})();

</script>
